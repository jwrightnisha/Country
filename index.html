<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Country CSV + SQL Tool</title>

  <!-- AlaSQL: SQL engine that runs entirely in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/alasql@1.7/dist/alasql.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #ffffe0;
      margin: 0;
      padding: 10px 20px;
    }

    h2 {
      margin: 0 0 5px 0;
    }

    .top-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .file-label {
      font-weight: bold;
      margin-right: 10px;
    }

    .fields-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }

    .field-group input {
      width: 110px;
      padding: 3px 5px;
      border-radius: 3px;
      border: 1px solid #999;
    }

    .button-main {
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid #688c7a;
      background-color: #c8e6da;
      color: #c00;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
    }

    .button-main:hover {
      filter: brightness(0.95);
    }

    .button-secondary {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #688c7a;
      background-color: #e1f2ea;
      cursor: pointer;
      font-size: 14px;
    }

    .button-secondary:hover {
      filter: brightness(0.97);
    }

    .bottom-row {
      display: grid;
      grid-template-columns: 1fr 1.5fr;
      gap: 20px;
      margin-top: 15px;
      align-items: start;
    }

    #sqlInput {
      width: 100%;
      height: 120px;
      padding: 5px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #999;
      font-family: Consolas, "Courier New", monospace;
    }

    #output {
      width: 100%;
      height: 260px;
      padding: 5px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #999;
      font-family: Consolas, "Courier New", monospace;
      white-space: pre;
    }

    .left-bottom-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .status {
      margin-top: 5px;
      font-size: 12px;
      color: #555;
    }

    .examples-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h2>Import File</h2>

  <div class="top-row">
    <span class="file-label">CSV:</span>
    <input type="file" id="fileInput" accept=".csv" />
    <button id="downloadBtn" class="button-secondary" type="button">
      Save Current Data as CSV
    </button>
    <span id="status" class="status">No file loaded.</span>
  </div>

  <!-- Row of input fields for a new record -->
  <div class="fields-row">
    <div class="field-group">
      <input type="number" id="idInput" />
      <span>ID</span>
    </div>
    <div class="field-group">
      <input type="text" id="countryInput" />
      <span>Country</span>
    </div>
    <div class="field-group">
      <input type="text" id="isoInput" />
      <span>ISO</span>
    </div>
    <div class="field-group">
      <input type="text" id="regionInput" />
      <span>Region</span>
    </div>
    <div class="field-group">
      <input type="number" id="populationInput" />
      <span>Population</span>
    </div>
    <div class="field-group">
      <input type="number" id="gdpInput" step="0.01" />
      <span>GDP</span>
    </div>
    <div class="field-group">
      <input type="number" id="gdpPcInput" step="0.01" />
      <span>GDP / Capita</span>
    </div>
    <div class="field-group">
      <input type="number" id="lifeExpInput" step="0.01" />
      <span>Life Exp.</span>
    </div>
    <div class="field-group">
      <input type="number" id="co2Input" step="0.01" />
      <span>CO₂ Emissions</span>
    </div>

    <button id="createBtn" class="button-main" type="button">
      Create New
    </button>
  </div>

  <div class="bottom-row">
    <div class="left-bottom-controls">
      <textarea id="sqlInput" placeholder="Type SQL here, e.g.&#10;SELECT * FROM countries LIMIT 10;"></textarea>
      <button id="runSqlBtn" class="button-main" type="button">Run SQL</button>

      <!-- Example SQL buttons -->
      <div class="examples-row">
        <button class="button-secondary" type="button"
          onclick="setExample('SELECT * FROM countries LIMIT 10;')">
          Example 1: All (10 rows)
        </button>
        <button class="button-secondary" type="button"
          onclick="setExample('SELECT Country, Population FROM countries ORDER BY Population DESC LIMIT 10;')">
          Top 10 by Population
        </button>
        <button class="button-secondary" type="button"
          onclick="setExample('SELECT Region, AVG(GDP_per_capita) AS avg_gdp_pc FROM countries GROUP BY Region ORDER BY avg_gdp_pc DESC;')">
          Avg GDP/Capita by Region
        </button>
        <button class="button-secondary" type="button"
          onclick="setExample('SELECT Country, Life_expectancy FROM countries WHERE Life_expectancy &gt; 80 ORDER BY Life_expectancy DESC;')">
          Life Expectancy &gt; 80
        </button>
        <button class="button-secondary" type="button"
          onclick="setExample('SELECT Country, CO2_emissions FROM countries ORDER BY CO2_emissions DESC LIMIT 10;')">
          Top CO₂ Emitters
        </button>
      </div>
    </div>

    <textarea id="output" readonly placeholder="SQL output will appear here..."></textarea>
  </div>

  <script>
    // In-memory representation of the CSV file
    let dataRows = [];
    const headers = [
      "ID",
      "Country",
      "ISO",
      "Region",
      "Population",
      "GDP",
      "GDP_per_capita",
      "Life_expectancy",
      "CO2_emissions"
    ];

    const statusSpan = document.getElementById("status");
    const outputArea = document.getElementById("output");

    function setExample(sql) {
      document.getElementById("sqlInput").value = sql;
    }

    // Initialize empty table
    function initEmptyTable() {
      alasql("DROP TABLE IF EXISTS countries");
      alasql(
        "CREATE TABLE countries (" +
          "ID INT, Country STRING, ISO STRING, Region STRING, " +
          "Population INT, GDP FLOAT, " +
          "GDP_per_capita FLOAT, Life_expectancy FLOAT, CO2_emissions FLOAT)"
      );
    }

    // Load JS array 'dataRows' into AlaSQL table
    function loadIntoDatabase() {
      initEmptyTable();
      dataRows.forEach((row) => {
        alasql("INSERT INTO countries VALUES (?,?,?,?,?,?,?,?,?)", [
          row.ID,
          row.Country,
          row.ISO,
          row.Region,
          row.Population,
          row.GDP,
          row.GDP_per_capita,
          row.Life_expectancy,
          row.CO2_emissions
        ]);
      });
      statusSpan.textContent =
        "Loaded " + dataRows.length + " row(s) into table 'countries'.";
    }

    // Simple CSV parser for well-formed CSV (no embedded commas)
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length <= 1) {
        dataRows = [];
        loadIntoDatabase();
        return;
      }

      // Assume first line is header; ignore its content and use our fixed schema.
      dataRows = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const cells = line.split(",");
        // Allow shorter rows; pad with empty strings
        while (cells.length < headers.length) cells.push("");

        const row = {
          ID: parseInt(cells[0], 10) || 0,
          Country: cells[1] || "",
          ISO: cells[2] || "",
          Region: cells[3] || "",
          Population: parseInt(cells[4], 10) || 0,
          GDP: parseFloat(cells[5]) || 0,
          GDP_per_capita: parseFloat(cells[6]) || 0,
          Life_expectancy: parseFloat(cells[7]) || 0,
          CO2_emissions: parseFloat(cells[8]) || 0
        };

        dataRows.push(row);
      }

      loadIntoDatabase();
    }

    // File input handler
    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (evt) => {
        parseCSV(evt.target.result);
        outputArea.value = "";
      };
      reader.readAsText(file);
    });

    // Create New row from input boxes
    document.getElementById("createBtn").addEventListener("click", () => {
      const row = {
        ID: parseInt(document.getElementById("idInput").value, 10) || 0,
        Country: document.getElementById("countryInput").value.trim(),
        ISO: document.getElementById("isoInput").value.trim(),
        Region: document.getElementById("regionInput").value.trim(),
        Population:
          parseInt(document.getElementById("populationInput").value, 10) || 0,
        GDP: parseFloat(document.getElementById("gdpInput").value) || 0,
        GDP_per_capita:
          parseFloat(document.getElementById("gdpPcInput").value) || 0,
        Life_expectancy:
          parseFloat(document.getElementById("lifeExpInput").value) || 0,
        CO2_emissions:
          parseFloat(document.getElementById("co2Input").value) || 0
      };

      dataRows.push(row);
      alasql("INSERT INTO countries VALUES (?,?,?,?,?,?,?,?,?)", [
        row.ID,
        row.Country,
        row.ISO,
        row.Region,
        row.Population,
        row.GDP,
        row.GDP_per_capita,
        row.Life_expectancy,
        row.CO2_emissions
      ]);

      statusSpan.textContent =
        "Row added. Total rows in 'countries': " + dataRows.length;

      // Clear inputs
      document.getElementById("idInput").value = "";
      document.getElementById("countryInput").value = "";
      document.getElementById("isoInput").value = "";
      document.getElementById("regionInput").value = "";
      document.getElementById("populationInput").value = "";
      document.getElementById("gdpInput").value = "";
      document.getElementById("gdpPcInput").value = "";
      document.getElementById("lifeExpInput").value = "";
      document.getElementById("co2Input").value = "";
    });

    // Run SQL from textarea
    document.getElementById("runSqlBtn").addEventListener("click", () => {
      const sql = document.getElementById("sqlInput").value.trim();
      if (!sql) {
        outputArea.value = "Please type a SQL statement.";
        return;
      }

      try {
        const result = alasql(sql);

        // If SELECT, result is usually an array of objects
        if (Array.isArray(result)) {
          if (result.length === 0) {
            outputArea.value = "(No rows returned.)";
            return;
          }

          const cols = Object.keys(result[0]);
          const lines = [];
          lines.push(cols.join("\t")); // header row

          result.forEach((row) => {
            lines.push(
              cols
                .map((c) => (row[c] === undefined ? "" : String(row[c])))
                .join("\t")
            );
          });

          outputArea.value = lines.join("\n");
        } else {
          // For non-SELECT statements, show the result (e.g., number of affected rows)
          outputArea.value = String(result);
        }
      } catch (err) {
        outputArea.value = "Error: " + err.message;
      }
    });

    // Download the current dataRows as CSV
    document.getElementById("downloadBtn").addEventListener("click", () => {
      if (!dataRows.length) {
        alert("No data to save.");
        return;
      }

      const lines = [];
      lines.push(headers.join(","));
      dataRows.forEach((row) => {
        lines.push(
          [
            row.ID,
            row.Country,
            row.ISO,
            row.Region,
            row.Population,
            row.GDP,
            row.GDP_per_capita,
            row.Life_expectancy,
            row.CO2_emissions
          ].join(",")
        );
      });

      const blob = new Blob([lines.join("\n")], {
        type: "text/csv;charset=utf-8;"
      });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = "countries.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    // Set up empty DB on first load so SQL is available even before import
    initEmptyTable();
  </script>
</body>
</html>
